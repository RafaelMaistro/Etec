<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tela de Login</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Inter, Segoe UI, Arial, Helvetica, sans-serif;
      background: #f6f7f8;
      color: #222;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    header { width: 100%; position: absolute; top: 0; left: 0; }
    .topo {
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 18px 24px;
      height: 80px;
      width: 100%;
    }
    .faixa-vinho { width: 100%; height: 80px; background-color: #b20000; }
    .logos img { height: 45px; background-color: #fff; border-radius: 5px; padding: 4px; }

    main { margin-top: 160px; display: flex; justify-content: center; width: 100%; }

    .login-container {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 40px;
      box-shadow: 0 6px 18px rgba(20, 30, 50, 0.1);
      width: 360px;
      text-align: center;
    }
    .login-container h2 { color: #000000; margin-bottom: 20px; }
    .icon img { width: 80px; height: 80px; margin-bottom: 15px; }

    select, input[type="text"], input[type="password"] {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #dde3ea;
      border-radius: 8px;
      background: #fbfcfd;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 10px;
      background-color: #b20000;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background-color: #8c0000; }

    .resultado {
      margin-top: 15px;
      font-size: 14px;
      color: red;
      display: none;
    }
  </style>
</head>

<body>


<header>
  <div class="topo">
      <div class="logos"><img src="Screenshot 2025-10-20 075927.png" alt="Logo"></div>
      <div style="flex:1">
      <strong>Login</strong>
      <div class="muted">ETEC Júlio de Mesquita</div>
    </div>
    </div>
  <div class="faixa-vinho"></div>
</header>


<main>
  <div class="login-container">

    <div class="icon">
      <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Administrador">
    </div>

    <h2>Login</h2>

    <select id="tipo">
      <option value="Administrador">Administrador</option>
      <option value="Professor">Professor</option>
      <option value="Técnico">Técnico</option>
    </select>

    <input type="text" id="login" placeholder="Email">
    <input type="password" id="senha" placeholder="Senha">

    <button onclick="fazerLogin()">Entrar</button>

    <div class="resultado" id="resultado"></div>
  </div>
</main>

<script>

function normalizar(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

const API_BASE = "http://localhost:3000";

async function fazerLogin() {
  const tipoSelecionado = document.getElementById("tipo").value; 
  const login = document.getElementById("login").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const resultado = document.getElementById("resultado");

  if (!login || !senha) {
    resultado.style.display = "block";
    resultado.style.color = "red";
    resultado.textContent = "Preencha todos os campos.";
    return;
  }

  try {
    
    const res = await fetch(API_BASE + "/usuarios");
    const usuarios = await res.json();

   
    const usuario = usuarios.find(u =>
      u.email === login &&
      u.senha === senha &&
      normalizar(u.funcao) === normalizar(tipoSelecionado)
    );

    if (!usuario) {
      resultado.style.display = "block";
      resultado.style.color = "red";
      resultado.textContent = "Usuário ou função incorretos.";
      return;
    }

   
    sessionStorage.setItem("currentUser", JSON.stringify(usuario));

    resultado.style.display = "block";
    resultado.style.color = "green";
    resultado.textContent = `Login bem-sucedido como ${tipoSelecionado}.`;

    setTimeout(() => {
      const tipoNorm = normalizar(tipoSelecionado);
      if (tipoNorm === "administrador") window.location.href = "Administrador.html";
      else if (tipoNorm === "professor") window.location.href = "professor.html";
      else window.location.href = "Tecnico.html";
    }, 600);

  } catch (e) {
    console.error("Erro no login:", e);
    resultado.style.display = "block";
    resultado.style.color = "red";
    resultado.textContent = "Erro ao conectar ao servidor.";
  }
}
</script>

<script>

async function syncFromServer() {
  try {
    const [usuariosRes, materiaisRes, problemasRes, agendamentosRes] = await Promise.all([
      fetch(API_BASE + '/usuarios'),
      fetch(API_BASE + '/materiais'),
      fetch(API_BASE + '/problemas'),
      fetch(API_BASE + '/agendamentos')
    ]);

    const usuarios = await usuariosRes.json();
    const materiais = await materiaisRes.json();
    const problemas = await problemasRes.json();
    const agendamentos = await agendamentosRes.json();

    localStorage.setItem('usuarios', JSON.stringify(usuarios));
    localStorage.setItem('materiais', JSON.stringify(materiais));
    localStorage.setItem('problemas', JSON.stringify(problemas));

    const appts = {};
    agendamentos.forEach(a => appts[a._id] = a);

    localStorage.setItem('appts', JSON.stringify(appts));
    localStorage.setItem('agendamentos', JSON.stringify(agendamentos));

  } catch(err) {
    console.error("Erro ao sincronizar servidor:", err);
  }
}

document.addEventListener("DOMContentLoaded", () => setTimeout(syncFromServer, 300));
</script>

</body>
</html>
